<?php
// Memulai sesi untuk menyimpan data login
session_start();

// 1. PENGATURAN KONEKSI DATABASE
// Sesuaikan dengan detail koneksi database Anda
$host = 'localhost';      // Biasanya 'localhost'
$db_user = 'root';        // Username database Anda
$db_pass = '';            // Password database Anda
$db_name = 'db_produksi_sawit'; // Nama database Anda

// Membuat koneksi ke database
$koneksi = mysqli_connect($host, $db_user, $db_pass, $db_name);

// Cek koneksi
if (!$koneksi) {
    die("Koneksi ke database gagal: " . mysqli_connect_error());
}

// 2. MENGAMBIL DATA DARI FORM LOGIN (index.php)
$username = $_POST['username'];
$password = $_POST['password'];

// 3. MELAKUKAN QUERY KE DATABASE
// Gunakan prepared statements untuk keamanan
$sql = "SELECT id, username, password, nama_lengkap FROM users WHERE username = ?";
$stmt = mysqli_prepare($koneksi, $sql);

// Bind parameter ke statement
mysqli_stmt_bind_param($stmt, "s", $username);

// Eksekusi statement
mysqli_stmt_execute($stmt);

// Ambil hasilnya
$result = mysqli_stmt_get_result($stmt);

// Cek apakah user ditemukan
if ($user = mysqli_fetch_assoc($result)) {
    // 4. VERIFIKASI PASSWORD
    // Cek apakah password yang diinput cocok dengan hash di database
    if (password_verify($password, $user['password'])) {
        // Jika password benar, simpan data user ke dalam session
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['nama_lengkap'] = $user['nama_lengkap'];
        $_SESSION['is_logged_in'] = true;

        // Arahkan ke halaman dashboard atau halaman utama setelah login
        header("Location: /web_magang_ptpnIV_regional4/pages/dashboard.php");
        exit();
    }
}

// 5. JIKA LOGIN GAGAL
// Jika username tidak ditemukan atau password salah, arahkan kembali ke halaman login dengan pesan error
header("Location: index.php?error=1");
exit();

?>